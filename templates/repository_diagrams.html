{% extends "base.html" %} {% block title %}Diagrams - {{ repository.name }} -
Noctum{% endblock %} {% block content %}
<style>
    .breadcrumb {
        margin-bottom: 1rem;
        color: var(--text-secondary);
    }
    .breadcrumb a {
        color: var(--accent);
        text-decoration: none;
    }
    .breadcrumb a:hover {
        text-decoration: underline;
    }

    .repo-header {
        margin-bottom: 1.5rem;
    }
    .repo-path {
        color: var(--text-secondary);
        font-family: monospace;
        margin-bottom: 0;
    }

    .diagram-grid {
        display: grid;
        gap: 1.5rem;
    }

    .diagram-card {
        border-left: 3px solid var(--accent);
    }

    .diagram-card h3 {
        margin-bottom: 0.5rem;
        color: var(--text-primary);
    }

    .diagram-description {
        color: var(--text-secondary);
        margin-bottom: 1rem;
        font-size: 0.9rem;
    }

    .diagram-wrapper {
        position: relative;
        margin-bottom: 1rem;
    }

    .diagram-toolbar {
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .diagram-btn {
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        color: var(--text-secondary);
        padding: 0.375rem 0.75rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        transition:
            background-color 0.2s,
            color 0.2s;
    }

    .diagram-btn:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
    }

    .diagram-btn svg {
        width: 14px;
        height: 14px;
    }

    .diagram-container {
        background: #ffffff;
        border-radius: 6px;
        padding: 1rem;
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
        cursor: grab;
    }

    .diagram-container:active {
        cursor: grabbing;
    }

    .diagram-content {
        transform-origin: center center;
        transition: transform 0.1s ease-out;
    }

    .diagram-container svg {
        max-width: 100%;
        height: auto;
        display: block;
    }

    .zoom-info {
        position: absolute;
        bottom: 0.5rem;
        right: 0.5rem;
        background: rgba(0, 0, 0, 0.7);
        color: #ffffff;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-family: monospace;
        pointer-events: none;
    }

    /* Fullscreen styles */
    .diagram-wrapper.fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9999;
        background: var(--bg-primary);
        padding: 1rem;
        display: flex;
        flex-direction: column;
    }

    .diagram-wrapper.fullscreen .diagram-toolbar {
        flex-shrink: 0;
    }

    .diagram-wrapper.fullscreen .diagram-container {
        flex: 1;
        min-height: 0;
    }

    .diagram-source {
        margin-top: 1rem;
    }

    .diagram-source summary {
        cursor: pointer;
        color: var(--text-secondary);
        font-size: 0.875rem;
        user-select: none;
    }

    .diagram-source summary:hover {
        color: var(--text-primary);
    }

    .diagram-source pre {
        margin-top: 0.5rem;
        background: var(--bg-tertiary);
        padding: 1rem;
        border-radius: 6px;
        overflow-x: auto;
        font-size: 0.8rem;
        font-family: "SF Mono", Monaco, "Cascadia Code", monospace;
    }

    .diagram-meta {
        color: var(--text-secondary);
        font-size: 0.75rem;
        margin-top: 0.5rem;
    }

    .empty-state {
        color: var(--text-secondary);
        padding: 3rem;
        text-align: center;
    }
</style>

<div class="breadcrumb">
    <a href="/repositories">Repositories</a> / {{ repository.name }}
</div>

<div class="repo-header">
    <h1>{{ repository.name }}</h1>
    <p class="repo-path">{{ repository.path }}</p>
</div>

<nav class="tabs">
    <a href="/repositories/{{ repository.id }}/architecture" class="tab"
        >Architecture</a
    >
    <a href="/repositories/{{ repository.id }}/files" class="tab"
        >File Analysis</a
    >
    <a href="/repositories/{{ repository.id }}/mutations" class="tab"
        >Mutation Testing</a
    >
    <a href="/repositories/{{ repository.id }}/diagrams" class="tab active"
        >Diagrams</a
    >
</nav>

{% if diagrams.is_empty() %}
<div class="card">
    <div class="empty-state">
        <p>No diagrams generated yet.</p>
        <p style="margin-top: 0.5rem">
            Diagrams are generated automatically during the scheduled window.
        </p>
    </div>
</div>
{% else %}
<div class="diagram-grid">
    {% for diagram in diagrams %}
    <div class="card diagram-card">
        <h3>{{ diagram.title }}</h3>
        <p class="diagram-description">{{ diagram.description }}</p>
        <div class="diagram-wrapper" data-diagram-id="{{ loop.index }}">
            <div class="diagram-toolbar">
                <button
                    class="diagram-btn"
                    onclick="zoomOut({{ loop.index }})"
                    title="Zoom out"
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <circle cx="11" cy="11" r="8" />
                        <line x1="21" y1="21" x2="16.65" y2="16.65" />
                        <line x1="8" y1="11" x2="14" y2="11" />
                    </svg>
                    Zoom Out
                </button>
                <button
                    class="diagram-btn"
                    onclick="resetZoom({{ loop.index }})"
                    title="Reset zoom"
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path
                            d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"
                        />
                        <path d="M3 3v5h5" />
                    </svg>
                    Reset
                </button>
                <button
                    class="diagram-btn"
                    onclick="zoomIn({{ loop.index }})"
                    title="Zoom in"
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <circle cx="11" cy="11" r="8" />
                        <line x1="21" y1="21" x2="16.65" y2="16.65" />
                        <line x1="11" y1="8" x2="11" y2="14" />
                        <line x1="8" y1="11" x2="14" y2="11" />
                    </svg>
                    Zoom In
                </button>
                <button
                    class="diagram-btn"
                    onclick="toggleFullscreen({{ loop.index }})"
                    title="Toggle fullscreen"
                >
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        class="fullscreen-icon"
                    >
                        <polyline points="15 3 21 3 21 9" />
                        <polyline points="9 21 3 21 3 15" />
                        <line x1="21" y1="3" x2="14" y2="10" />
                        <line x1="3" y1="21" x2="10" y2="14" />
                    </svg>
                    <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        class="exit-fullscreen-icon"
                        style="display: none"
                    >
                        <polyline points="4 14 10 14 10 20" />
                        <polyline points="20 10 14 10 14 4" />
                        <line x1="14" y1="10" x2="21" y2="3" />
                        <line x1="3" y1="21" x2="10" y2="14" />
                    </svg>
                    <span class="fullscreen-text">Fullscreen</span>
                </button>
            </div>
            <div
                class="diagram-container"
                onwheel="handleWheel(event, {{ loop.index }})"
                onmousedown="startPan(event, {{ loop.index }})"
                onmousemove="doPan(event, {{ loop.index }})"
                onmouseup="endPan({{ loop.index }})"
                onmouseleave="endPan({{ loop.index }})"
            >
                <div
                    class="diagram-content"
                    data-zoom="1"
                    data-pan-x="0"
                    data-pan-y="0"
                >
                    {{ diagram.svg_content|safe }}
                </div>
                <div class="zoom-info">100%</div>
            </div>
        </div>
        <details class="diagram-source">
            <summary>View DOT Source</summary>
            <pre><code>{{ diagram.dot_content }}</code></pre>
        </details>
        <div class="diagram-meta">Updated: {{ diagram.created_at }}</div>
    </div>
    {% endfor %}
</div>

<script>
    const diagramState = {};

    function getState(id) {
        if (!diagramState[id]) {
            diagramState[id] = {
                zoom: 1,
                panX: 0,
                panY: 0,
                isPanning: false,
                startX: 0,
                startY: 0,
            };
        }
        return diagramState[id];
    }

    function getElements(id) {
        const wrapper = document.querySelector(`[data-diagram-id="${id}"]`);
        const content = wrapper.querySelector(".diagram-content");
        const zoomInfo = wrapper.querySelector(".zoom-info");
        return { wrapper, content, zoomInfo };
    }

    function updateTransform(id) {
        const state = getState(id);
        const { content, zoomInfo } = getElements(id);
        content.style.transform = `translate(${state.panX}px, ${state.panY}px) scale(${state.zoom})`;
        zoomInfo.textContent = `${Math.round(state.zoom * 100)}%`;
    }

    function zoomIn(id) {
        const state = getState(id);
        state.zoom = Math.min(state.zoom * 1.25, 5);
        updateTransform(id);
    }

    function zoomOut(id) {
        const state = getState(id);
        state.zoom = Math.max(state.zoom / 1.25, 0.1);
        updateTransform(id);
    }

    function resetZoom(id) {
        const state = getState(id);
        state.zoom = 1;
        state.panX = 0;
        state.panY = 0;
        updateTransform(id);
    }

    function handleWheel(event, id) {
        event.preventDefault();
        const state = getState(id);
        const delta = event.deltaY > 0 ? 0.9 : 1.1;
        state.zoom = Math.min(Math.max(state.zoom * delta, 0.1), 5);
        updateTransform(id);
    }

    function startPan(event, id) {
        if (event.button !== 0) return;
        const state = getState(id);
        state.isPanning = true;
        state.startX = event.clientX - state.panX;
        state.startY = event.clientY - state.panY;
    }

    function doPan(event, id) {
        const state = getState(id);
        if (!state.isPanning) return;
        state.panX = event.clientX - state.startX;
        state.panY = event.clientY - state.startY;
        updateTransform(id);
    }

    function endPan(id) {
        const state = getState(id);
        state.isPanning = false;
    }

    function toggleFullscreen(id) {
        const { wrapper } = getElements(id);
        const isFullscreen = wrapper.classList.toggle("fullscreen");
        const btn = wrapper.querySelector('[onclick^="toggleFullscreen"]');
        const fullscreenIcon = btn.querySelector(".fullscreen-icon");
        const exitIcon = btn.querySelector(".exit-fullscreen-icon");
        const text = btn.querySelector(".fullscreen-text");

        if (isFullscreen) {
            fullscreenIcon.style.display = "none";
            exitIcon.style.display = "block";
            text.textContent = "Exit";
            document.body.style.overflow = "hidden";
        } else {
            fullscreenIcon.style.display = "block";
            exitIcon.style.display = "none";
            text.textContent = "Fullscreen";
            document.body.style.overflow = "";
        }
    }

    // Close fullscreen with Escape key
    document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
            const fullscreenWrapper = document.querySelector(
                ".diagram-wrapper.fullscreen",
            );
            if (fullscreenWrapper) {
                const id = fullscreenWrapper.dataset.diagramId;
                toggleFullscreen(id);
            }
        }
    });
</script>
{% endif %} {% endblock %}
